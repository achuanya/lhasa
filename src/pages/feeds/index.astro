---
import Layout from "@/layouts/Layout.astro";
import Main from "@/layouts/Main.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Card from "@/components/Card.astro";
import { SITE } from "@/config";

interface FeedItem {
  blog_name: string;
  title: string;
  published: string;
  link: string;
  avatar: string;
}

interface FeedsData {
  items: FeedItem[];
  updated: string;
}

const INITIAL_ITEMS_TO_SHOW = 4;
const FALLBACK_OG_IMAGE = "https://cos.lhasa.icu/LinksAvatar/default.png";

let allFeedsData: FeedsData = { items: [], updated: "" };
let errorFetching: string | null = null;

try {
  const response = await fetch("https://cos.lhasa.icu/lhasaRSS/data.json");
  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }
  allFeedsData = await response.json();
} catch (e) {
  if (e instanceof Error) {
    errorFetching = `Failed to fetch feeds: ${e.message}`;
  } else {
    errorFetching = "An unknown error occurred while fetching feeds.";
  }
}

const feedsDataForClient = {
  allFeeds: allFeedsData.items,
  siteTimezone: SITE.timezone,
  fallbackOgImage: FALLBACK_OG_IMAGE,
  initialItemCount: INITIAL_ITEMS_TO_SHOW,
  itemsPerPage: 4,
};
---

<Layout title={`Feeds | ${SITE.title}`}>
  <Header />
    <Main pageTitle="Feeds" pageDesc="">
    {errorFetching && (
      <div class="mb-4 rounded bg-red-100 p-4 text-red-700">
        <p>{errorFetching}</p>
        <p>Please check the data source or network connection.</p>
      </div>
    )}
    {allFeedsData.items && allFeedsData.items.length > 0 ? (
      <section id="feeds-list-section" class="px-0">
        <ul id="feeds-list" class="list-none p-0">
          {allFeedsData.items.slice(0, feedsDataForClient.initialItemCount).map(item => (
            // @ts-ignore
            <Card
              data={{
                title: item.title,
                description: `来自 ${item.blog_name}`,
                pubDatetime: new Date(item.published),
                ogImage: item.avatar,
                author: item.blog_name,
                modDatetime: null,
                featured: false,
                draft: false,
                tags: ["feed"],
                category: "Feed",
              }}
              id={item.link}
              filePath={item.link}
              variant="h3"
              showDescription={true}
              fallbackOgImage={feedsDataForClient.fallbackOgImage}
            />
          ))}
        </ul>
        {allFeedsData.items.length > feedsDataForClient.initialItemCount && (
          <div id="load-more-trigger" class="h-10"></div>
        )}
      </section>
    ) : (
      !errorFetching && <p>暂无内容。</p>
    )}
  </Main>
  <Footer />
</Layout>

<div id="feeds-data-json-container" data-json={JSON.stringify(feedsDataForClient)} style="display: none;"></div>

<script>
  import { initFeeds } from '@/scripts/feeds.js';

  document.addEventListener('astro:page-load', () => {
    const dataElement = document.getElementById('feeds-data-json-container');

    if (dataElement && dataElement.dataset.json) {
      try {
        const clientData = JSON.parse(dataElement.dataset.json);
        initFeeds(
          clientData.allFeeds,
          clientData.siteTimezone,
          clientData.fallbackOgImage,
          clientData.initialItemCount,
          clientData.itemsPerPage
        );
      } catch (e) {
        console.error("Failed to parse feeds client data or initialize feeds:", e);
      }
    }
  });
</script>

<style>
  #feeds-list-section {
    padding-inline: 0;
  }
</style>