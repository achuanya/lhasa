---
import IconBike from "@/assets/icons/IconBike.svg";
import IconRunner from "@/assets/icons/IconRunner.svg";
import "../styles/sports.css";
---
  
<div class="container mx-auto max-w-[736px]">
  <div id="totalActivities">
      <div id="totalTitle" class="total-title"></div>
      <div id="totalCount" class="total-count">
          <span id="ridingTimeThisYearValue">0</span>
          <div class="loading-spinner"></div>
      </div>
      <div id="totalLabel" class="total-label">骑行总公里数</div>
      <div id="milesRiddenThisYear" class="total-distance">
          <span id="milesRiddenThisYearValue">0</span>
          <div class="loading-spinner"></div>
      </div>
  </div>
  <div id="calendar" class="calendar"></div>
  <div class="sports">
      <div class="icon-container">
          <div class="icon-item">
              <div class="road_bike_color"></div>
              <IconBike class="icon-svg cycling" />
          </div>
          <div class="icon-item">
              <div class="running_color"></div>
              <IconRunner class="icon-svg running" />
          </div>
      </div>
      <div id="barChart" class="bar-chart"></div>
  </div>
</div>

<script is:inline data-astro-rerun>
(function() {
    // 单例模式存储 Sports 实例状态
    window.sportsInstance = window.sportsInstance || null;

    // 销毁现有实例
    function destroySports() {
        if (window.sportsInstance) {
            try {
                // 清理定时器和事件监听器
                if (window.sportsInstance.timers) {
                    window.sportsInstance.timers.forEach(timer => clearTimeout(timer));
                    window.sportsInstance.timers.forEach(timer => clearInterval(timer));
                }
                
                // 清理元素上的动画引用
                const ridingTimeElement = document.getElementById('ridingTimeThisYearValue');
                const milesElement = document.getElementById('milesRiddenThisYearValue');
                if (ridingTimeElement) {
                    if (ridingTimeElement._animationInterval) clearInterval(ridingTimeElement._animationInterval);
                    if (ridingTimeElement._animationTimeout) clearTimeout(ridingTimeElement._animationTimeout);
                }
                if (milesElement) {
                    if (milesElement._animationInterval) clearInterval(milesElement._animationInterval);
                    if (milesElement._animationTimeout) clearTimeout(milesElement._animationTimeout);
                }
                
                window.sportsInstance = null;
                console.log('Sports 实例已销毁');
            } catch (err) {
                console.error('销毁Sports失败:', err);
            }
        }
        
        // 清理主题观察器
        if (window._sportsThemeObserver) {
            window._sportsThemeObserver.disconnect();
            window._sportsThemeObserver = null;
        }
    }

    // 初始化 Sports 实例
    function initSports() {
        const calendarElement = document.getElementById('calendar');
        const barChartElement = document.getElementById('barChart');
        
        if (!calendarElement || !barChartElement) return;

        // 创建新实例
        window.sportsInstance = {
            timers: [],
            processedActivities: [],
            totalActivitiesDisplayed: false
        };

        // 为了数据的统一性,generateCalendar处理后赋值供全局使用
        let processedActivities = [];

        // 日历
        function generateCalendar(activities, startDate, numWeeks) {
            const calendarElement = document.getElementById('calendar');
            // 清空当前日历内容
            calendarElement.innerHTML = ''; 
            
            const daysOfWeek = ['一', '二', '三', '四', '五', '六', '日']; 
            daysOfWeek.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-week-header';
                dayElement.innerText = day;
                calendarElement.appendChild(dayElement);
            });

            const todayStr = getChinaTime().toISOString().split('T')[0];
            let currentDate = new Date(startDate);
            currentDate.setUTCHours(0, 0, 0, 0);

            // 清空处理过的活动数据
            processedActivities = [];
            let todayContainer = null;

            // 创建日历
            function createDayContainer(date, activities) {
                const dayContainer = document.createElement('div');
                dayContainer.className = 'day-container';

                const dateNumber = document.createElement('span');
                dateNumber.className = 'date-number';
                dateNumber.innerText = date.getUTCDate();
                dayContainer.appendChild(dateNumber);

                // 查找当前日期是否有活动数据
                const activity = activities.find(activity => activity.start_date_local === date.toISOString().split('T')[0]);
                // console.log(processedActivities);
                if (activity) processedActivities.push(activity);

                // 根据骑行距离设置球的大小
                const ballSize = activity ? Math.min(parseFloat(activity.distance) / 4, 24) : 2;

                const ball = document.createElement('div');
                ball.className = 'activity-indicator';
                ball.style.width = `${ballSize}px`;
                ball.style.height = `${ballSize}px`;
                if (!activity) ball.classList.add('no-activity');
                ball.style.left = '50%';
                ball.style.top = '50%';
                dayContainer.appendChild(ball);

                // 鼠标悬停动画
                dayContainer.addEventListener('mouseenter', () => {
                    if (date.toDateString() === new Date().toDateString()) {
                        dateNumber.style.opacity = '0';
                        ball.style.opacity = '1';
                    } else {
                        if (todayContainer) {
                            todayContainer.querySelector('.date-number').style.opacity = '0';
                            todayContainer.querySelector('.activity-indicator').style.opacity = '1';
                        }
                    }
                });
                dayContainer.addEventListener('mouseleave', () => {
                    if (date.toDateString() === new Date().toDateString()) {
                        dateNumber.style.opacity = '1';
                        ball.style.opacity = '0';
                    } else {
                        if (todayContainer) {
                            todayContainer.querySelector('.date-number').style.opacity = '1';
                            todayContainer.querySelector('.activity-indicator').style.opacity = '0';
                        }
                    }
                });

                // 如果是今天的日期，添加特定样式
                if (date.toDateString() === new Date().toDateString()) {
                    // 记录今天的日期
                    todayContainer = dayContainer;
                    dayContainer.classList.add('today');
                    // 不再使用内联样式，改为通过 CSS 类来控制样式
                    dateNumber.style.opacity = '1';
                    ball.style.opacity = '0';
                }
                return dayContainer;
            }

            // 异步显示,模仿打字机效果
            async function displayCalendar() {
                for (let week = 0; week < numWeeks; week++) {
                    for (let day = 0; day < 7; day++) {
                        const currentDateStr = currentDate.toISOString().split('T')[0];
                        // 不再计算超过今天的日期
                        if (currentDateStr > todayStr) return;
                        
                        const dayContainer = createDayContainer(currentDate, activities);
                        calendarElement.appendChild(dayContainer);

                        // 速度控制
                        await new Promise(resolve => {
                            const timer = setTimeout(resolve, 30);
                            window.sportsInstance.timers.push(timer);
                        });
                        currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                    }
                }
            }
            // 显示日历并在结束后显示柱形图和总活动数
            displayCalendar().then(() => {
                generateBarChart();
                displayTotalActivities(activities);
            });
        }

        // 生成柱形图
        function generateBarChart() {
            const barChartElement = document.getElementById('barChart');
            // 清空柱形图内容
            barChartElement.innerHTML = '';

            const today = getChinaTime();
            const startDate = getStartDate(today, 21);

            // 创建所有周的时间范围
            const weeklyData = {};
            let currentWeekStart = new Date(startDate);
            currentWeekStart.setUTCHours(0, 0, 0, 0);

            // 按周计算未来 4 周的日期范围
            for (let i = 0; i < 4; i++) {
                const weekStart = new Date(currentWeekStart);
                const weekEnd = new Date(weekStart);
                weekEnd.setUTCDate(weekStart.getUTCDate() + 6); // 一周结束日期为开始日期 +6 天
                const weekKey = `${weekStart.toISOString().split('T')[0]} - ${weekEnd.toISOString().split('T')[0]}`;

                weeklyData[weekKey] = 0; // 初始化每周骑行数据为 0
                currentWeekStart.setUTCDate(currentWeekStart.getUTCDate() + 7); // 移动到下一周
            }

            // 累加每周的骑行距离
            processedActivities.forEach(activity => {
                const activityDate = new Date(activity.start_date_local);
                const weekStart = getWeekStartDate(activityDate); // 活动所在周的开始日期
                const weekEnd = new Date(weekStart);
                weekEnd.setUTCDate(weekStart.getUTCDate() + 6);

                const weekKey = `${weekStart.toISOString().split('T')[0]} - ${weekEnd.toISOString().split('T')[0]}`;
                if (weeklyData[weekKey] !== undefined) {
                    weeklyData[weekKey] += parseFloat(activity.distance);
                }
            });

            // 获取最大骑行距离（用于柱形图比例）
            const maxDistance = Math.max(...Object.values(weeklyData), 0);

            // 创建并显示每周的柱形图
            Object.keys(weeklyData).forEach(week => {
                const distance = weeklyData[week]; // 当前周的骑行距离
                const barContainer = document.createElement('div');
                barContainer.className = 'bar-container';

                const bar = document.createElement('div');
                bar.className = 'bar';

                // 计算柱形图的宽度
                const width = maxDistance > 0 ? (distance / maxDistance) * 190 : 0;
                bar.style.setProperty('--bar-width', `${width}px`);

                const distanceText = document.createElement('div');
                distanceText.className = 'cycling-kilometer';
                distanceText.innerText = '0 km';

                const messageBox = createMessageBox();
                const clickMessageBox = createMessageBox();

                barContainer.style.position = 'relative';
                bar.appendChild(distanceText);
                barContainer.appendChild(bar);
                barContainer.appendChild(messageBox);
                barContainer.appendChild(clickMessageBox);
                barChartElement.appendChild(barContainer);

                // 动画效果：逐渐显示柱形图宽度
                bar.style.width = '0';
                bar.offsetHeight;
                bar.style.transition = 'width 1s ease-out';
                bar.style.width = `${width}px`;

                distanceText.style.opacity = '1';
                // 动态更新柱形图的数值
                animateText(distanceText, 0, distance, 1000, true);
                setupBarInteractions(bar, messageBox, clickMessageBox, distance);
            });
        }

        // 动态文本显示
        function animateText(element, startValue, endValue, duration, isDistance = false) {
            const startTime = performance.now();
            function update() {
                const elapsed = performance.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const currentValue = (progress * endValue).toFixed(2);
                element.innerText = isDistance ? `${currentValue} km` : `${currentValue}h`;
                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    element.innerText = isDistance ? `${endValue.toFixed(2)} km` : `${endValue.toFixed(2)}h`;
                }
            }
            update();
        }

        // 计算总公里数
        function calculateTotalKilometers(activities) {
            return activities.reduce((total, activity) => total + parseFloat(activity.distance) || 0, 0);
        }

        // 显示总活动数和总公里数
        function displayTotalActivities(activities) {
            // 防止重复执行
            if (window.sportsInstance.totalActivitiesDisplayed) return;
            window.sportsInstance.totalActivitiesDisplayed = true;
            
            // 全年骑行时长
            const ridingTimeThisYear = document.getElementById('totalCount');
            // 全年骑行公里数
            const milesRiddenThisYear = document.getElementById('milesRiddenThisYear');
            // 动态年标题《2025 骑行总时长》
            const totalTitleElement = document.getElementById('totalTitle');

            if (!ridingTimeThisYear || !milesRiddenThisYear || !totalTitleElement) return;

            const ridingTimeThisYearValue = ridingTimeThisYear.querySelector('#ridingTimeThisYearValue');
            const milesRiddenThisYearValue = milesRiddenThisYear.querySelector('#milesRiddenThisYearValue');

            const totalCountSpinner = ridingTimeThisYear.querySelector('.loading-spinner');
            const milesRiddenThisYearSpinner = milesRiddenThisYear.querySelector('.loading-spinner');

            totalCountSpinner.classList.add('active');
            milesRiddenThisYearSpinner.classList.add('active');

            const currentYear = new Date().getFullYear();
            totalTitleElement.textContent = `${currentYear} 骑行总时长`;

            // 筛选全年活动数据
            const filteredActivities = activities.filter(activity => {
                const activityYear = new Date(activity.start_date_local).getFullYear();
                return activityYear === currentYear;
            });

            // 计算全年活动时间的总和（单位：小时）
            const totalMovingTime = filteredActivities.reduce((total, activity) => {
                return total + parseFloat(activity.moving_time) || 0;
            }, 0);

            // 计算全年总公里数
            const totalKilometers = calculateTotalKilometers(filteredActivities);

            // 动画效果
            animateCount(ridingTimeThisYearValue, totalMovingTime, 1000, 50, false);
            animateCount(milesRiddenThisYearValue, totalKilometers, 1000, 50, true);

            const timer = setTimeout(() => {
                console.log(totalKilometers.toFixed(2));
                ridingTimeThisYearValue.textContent = `${totalMovingTime.toFixed(2)} h`;
                milesRiddenThisYearValue.textContent = `${totalKilometers.toFixed(2)} km`;
                totalCountSpinner.classList.remove('active');
                milesRiddenThisYearSpinner.classList.remove('active');
            }, 1000);
            window.sportsInstance.timers.push(timer);
        }

        // 获取一周的开始日期
        function getWeekStartDate(date) {
            const day = date.getDay();
            const diff = (day === 0 ? -6 : 1) - day;
            const weekStart = new Date(date);
            weekStart.setDate(weekStart.getDate() + diff);
            return weekStart;
        }

        // 获取中国时间 UTC+8
        function getChinaTime() {
            const now = new Date();
            const offset = 8 * 60 * 60 * 1000;
            return new Date(now.getTime() + offset);
        }

        // 手搓JSON
        async function loadActivityData() {
            const response = await fetch('https://cos.lhasa.icu/assets/strava_data.json');
            return response.json();
        }

        // 创建消息框
        function createMessageBox() {
            const messageBox = document.createElement('div');
            messageBox.className = 'message-box';
            return messageBox;
        }

        // 获取起始时间（从周一开始）
        function getStartDate(today, daysOffset) {
            const currentDayOfWeek = today.getUTCDay();
            const daysToMonday = (currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1);
            const startDate = new Date(today);
            startDate.setUTCDate(today.getUTCDate() - daysToMonday - daysOffset);
            return startDate;
        }

        // 动态更新计数器
        function animateCount(element, totalValue, duration, intervalDuration, isDistance = false) {
            // 清除可能存在的之前的动画
            if (element._animationInterval) {
                clearInterval(element._animationInterval);
            }
            if (element._animationTimeout) {
                clearTimeout(element._animationTimeout);
            }
            
            const step = totalValue / (duration / intervalDuration);
            let count = 0;
            
            const interval = setInterval(() => {
                count += step;
                if (count >= totalValue) {
                    count = totalValue;
                    clearInterval(interval);
                    element._animationInterval = null;
                    // 确保最终值正确
                    element.textContent = isDistance ? `${totalValue.toFixed(2)} km` : `${totalValue.toFixed(2)} h`;
                } else {
                    element.textContent = isDistance ? `${count.toFixed(2)} km` : `${count.toFixed(2)} h`;
                }
            }, intervalDuration);
            
            // 存储引用以便清理
            element._animationInterval = interval;
            window.sportsInstance.timers.push(interval);
        }

        // 柱形图交互
        function setupBarInteractions(bar, messageBox, clickMessageBox, weeklyData) {
            let mouseLeaveTimeout;
            let autoHideTimeout;

            bar.addEventListener('mouseenter', () => {
                clearTimeout(mouseLeaveTimeout);
                clearTimeout(autoHideTimeout);

                const message = weeklyData > 70 ? '骑行出发吧！' : '偷懒了';
                messageBox.innerText = message;
                messageBox.classList.add('show');

                autoHideTimeout = setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 700);
                window.sportsInstance.timers.push(autoHideTimeout);
            });

            bar.addEventListener('mouseleave', () => {
                mouseLeaveTimeout = setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 700);
                window.sportsInstance.timers.push(mouseLeaveTimeout);
            });

            bar.addEventListener('click', () => {
                clickMessageBox.innerText = '你也感兴趣吗';
                clickMessageBox.classList.add('show');
                const timer = setTimeout(() => {
                    clickMessageBox.classList.remove('show');
                }, 700);
                window.sportsInstance.timers.push(timer);

                messageBox.classList.remove('show');
                clearTimeout(mouseLeaveTimeout);
                clearTimeout(autoHideTimeout);
            });
        }

        // 加载数据并生成日历
        (async function() {
            const today = getChinaTime();
            const startDate = getStartDate(today, 21);

            try {
                const activities = await loadActivityData();
                // 显示4周的日历
                generateCalendar(activities, startDate, 4);
                // 注意：displayTotalActivities 已在 generateCalendar 的回调中调用，这里不再重复调用
                console.log('Sports 初始化完成');
            } catch (error) {
                console.error('加载运动数据失败:', error);
            }
        })();
    }

    // 页面生命周期管理
    function handlePageLoad() {
        destroySports();
        initSports();
    }

    // 主题切换处理
    function handleThemeChange() {
        console.log('主题切换，重新初始化 Sports 组件');
        destroySports();
        // 延迟一点时间确保 CSS 变量已更新
        setTimeout(() => {
            initSports();
        }, 50);
    }

    // 单次绑定事件监听
    function setupSports() {
        if (window._sportsInitialized) return;
        window._sportsInitialized = true;

        // 页面切换事件
        document.addEventListener('astro:before-swap', destroySports);
        document.addEventListener('astro:after-swap', handlePageLoad);

        // 监听主题切换
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                    handleThemeChange();
                }
            });
        });

        // 观察 html 元素的 data-theme 属性变化
        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['data-theme']
        });

        // 存储观察器以便清理
        window._sportsThemeObserver = observer;

        // 初始加载
        if (document.readyState === 'complete') {
            handlePageLoad();
        } else {
            document.addEventListener('DOMContentLoaded', handlePageLoad);
        }
    }

    setupSports();
})();
</script>